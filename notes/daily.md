# Day1 Log

## 仕様書
- 図書貸出システムの仕様 v1 を作成
- 曖昧語を含めた (「適切に」「十分に」「特別に」)

## 曖昧性解消
- 曖昧な仕様点: 
- 解消済み: 
- 未解決: 

## テスト生成
- JUnit テストを  件生成
- コンパイルエラー: 未定義クラス  件
- 状態: 赤テストを資産としてコミット

## コード生成（骨格）
- LLM により最小限の骨格コードを生成
- コンパイル成功
- テスト結果: 赤  件 (未実装のため)

## 所感
- 曖昧語を含めると質問リストが自然に抽出された
- 赤テストを先に確保できたため、次回から緑化サイクルに進める

## 作業メモ

### 曖昧な点をLLMに質問
```txt
この仕様書の曖昧な点をYes/No質問に変換してリスト化してください
```

### 曖昧な点のリスト
```txt
前提とユーザ

ユーザ登録が必要ですか？
認証済みユーザのみ貸出可能にしますか？
ユーザ種別（一般／職員など）で貸出ルールを分けますか？
未成年など特定属性で追加制限を設けますか？
ゲスト（未登録）に閲覧のみを許可しますか？
本の識別と対象範囲

「同じ本」はISBN（版を含む）で判定しますか？
同一タイトルの別版は「同じ本」と見なしますか？
複本（同一ISBNの別コピー）は別物として同時貸出可能にしますか？
電子書籍も貸出対象に含めますか？
館内資料（参考図書など）を貸出対象から除外しますか？
貸出ルール（上限・重複・期間）

1ユーザあたりの同時貸出冊数に上限を設けますか？
同一ユーザが同じ本を同時に複数コピー借りるのを禁止しますか？
既に借りている本を再度借りようとした場合はエラーにしますか？
貸出期間は固定日数で運用しますか？
貸出期間はユーザ種別や本の種別で変動させますか？
返却期限は貸出手続き日からの暦日で計算しますか（営業日換算はしませんか）？
延長・予約

期限延長（更新）を許可しますか？
延長回数に上限を設けますか？
予約待ちがある場合は延長を禁止しますか？
予約機能（待ち行列）を提供しますか？
予約取り置きの有効期限を設定しますか？
返却・延滞・罰則

返却は営業時間外（ブックポスト等）でも受け付けますか？
延滞時に自動で貸出停止期間を課しますか？
延滞料金（罰金）を課しますか？
大幅な延滞時に強制弁償扱いとしますか？
紛失・破損時の弁償処理フローをシステムで扱いますか？
人気本の特別扱い

人気本の判定を自動（貸出回数・予約数等）で行いますか？
人気本は通常本より貸出期間を短くしますか？
人気本は延長不可にしますか？
人気本の同時貸出冊数をより厳しく制限しますか？
人気本の予約上限（待ち人数）を設定しますか？
エラーハンドリング・通知

業務ルール違反時は処理をブロックしてエラーにしますか（警告のみではなく）？
エラーメッセージをユーザ向けに表示しますか？  
通知（貸出・期限接近・延滞・予約到来）をメールで送信しますか？
メール以外（SMS／プッシュ通知）も使用しますか？
APIがある場合、エラーコード体系を定義して返しますか？
運用・監査・データ

休館日設定を考慮（期限繰り上げ／繰り下げ）しますか？
管理者が貸出状態を手動で修正できるようにしますか？
監査ログ（誰が何をいつしたか）を記録しますか？
個人情報の保存を最小化（不要データは保存しない）しますか？
```

### １回目の回答
```txt
上で挙げてもらった曖昧な点リストに対して、以下の3件に答えました。

貸出期間は固定日数で運用しますか？ → はい、14日
同じ本を借りようとした場合はエラーにしますか？ → はい
人気本は通常本より貸出期間を短くしますか？ → はい、7日
残りの質問は TODO としてください。

これを反映して新しい仕様書を作成してください。

新しいファイルは spec/spec_v2.md に作成
タイトルは「図書貸出システム 仕様 v2」とする。
出力形式は Markdown。
```
# Day2 Log

## テスト生成
- 仕様 v2 から JUnit テストを生成
- 生成テスト数: 3
- 配置: app/src/test/java/BookLendingServiceTest.java

## 実行結果
- コンパイル: 成功
- テスト実行: 3件すべて失敗 (赤)
- ログ保存: notes/day2_test.log

## 所感
- コンパイルが通り、仕様に対応する赤テストの資産を確保。
- Day3: 骨格コード生成により1件緑化を目標。

## 作業メモ
### テスト生成プロンプト
```txt
次の仕様書ファイルを入力として扱ってください:
- 入力仕様書: spec/spec_v2.md

この仕様書の「決定事項」に基づき、JUnit5で失敗するテストコードを生成してください。

出力条件:
- 出力ファイル名: generated/BookLendingServiceTest.java
- 出力形式: Java ソースコードのみ
- クラス名: BookLendingServiceTest
- 外部依存はスタブ化してください。
- 実装が存在しない状態を想定し、赤テストになるコードにしてください。
- 各テストには「仕様の根拠」をコメントで明記してください。

【仕様の決定事項】（spec/spec_v2.md より）
- 貸出期間（通常本）: 固定14日。
- 重複貸出: 同じ本を借りようとした場合はエラーとする。
- 人気本の貸出期間: 固定7日（通常本より短い）。
```


# Day3 Log

## コード生成（骨格）
- 仕様 v2 に基づき、LLMで BookLendingService, User, Book の骨格コードを生成。
- 配置: app/src/main/java/BookLendingService.java
- 実装はダミー（TODO付与）、テストは赤のまま想定。

## 実行結果
- コマンド: ./gradlew build
- コンパイル: 成功
- テスト: 3件すべて失敗 (赤)
- ログ保存: notes/day3_build.log

## 所感
- 赤テストを実行可能にし、仕様→テスト→コードの接続を確認。
- Day4: 緑化ターゲットを1件に絞って最小実装。修正行数と所要時間を計測する。

## 作業メモ
### 骨格コード生成プロンプト
```txt
次の仕様ファイルを入力として扱ってください:
- 入力仕様書: spec/spec_v2.md

目的:
- 既存の赤テスト (app/src/test/java/BookLendingServiceTest.java) がコンパイルできるように、
  最小限の骨格コードを生成してください。

出力条件:
- 出力ファイル名: app/src/main/java/BookLendingService.java
- 依存クラス (User, Book) も同じパッケージに定義してください。
- 実装内容はダミーで構いません（テストは赤のままで良い）。
- コメントで「TODO: implement」と残してください。
- Java 21 構文を利用可能としてください。

【仕様の決定事項】
- 貸出期間（通常本）: 固定14日
- 重複貸出: 同じ本を借りようとした場合はエラーとする
- 人気本: 7日間
```
# Day4 Log

## 実装とテスト実行
- BookLendingServiceTest の SUT を NotImplementedBookLendingService から BookLendingService に差し替え。
- BookLendingService.java への修正指示は出していない。
- ./gradlew test を実行。

## 実行結果
- 通常本14日 → passed
- 人気本7日 → passed
- 重複貸出 → failed
- ログ保存: notes/day4_test.log

## 問題点
- 本来は「通常本14日のみ緑化」を狙ったが、人気本7日も同時に通過した。
- 修正指示を出していない段階で緑化が発生したのは、Day3 の骨格コードに既に 7日の定数が含まれていたためと推測。
- これは「LLM骨格生成段階で部分的に仕様を満たしてしまうリスク」を示す。

## 所感
- 予定外の緑化だが、研究データとして重要。
- 今後はこの事象を考慮し、骨格生成がどの程度仕様を満たしてしまうかも評価対象に加える。

# Day5 Log

## 実装とテスト実行
- 重複貸出テストの失敗を解消するため、設計整合を取る修正を実施。
- app/src/main/java に LoanRepository インタフェースを新規追加。
- BookLendingService を修正し、LoanRepository をコンストラクタ注入する方式に変更。
- lend() 内で loanRepository.hasActiveLoan(...) を参照して重複判定、成功時には loanRepository.addLoan(...) を呼ぶようにした。
- BookLendingServiceTest を修正し、LoanRepository スタブを生成して注入する形に統一。
- ./gradlew test を実行。

## 実行結果
- 通常本14日 → passed
- 人気本7日 → passed
- 重複貸出 → passed
- ログ保存: notes/day5_test.log

## 所感
- LoanRepository を共有契約として導入することで、テストと実装の前提が一致。
- 設計整合を取ることで、仕様→テスト→実装の一貫性を担保できた。
- LLM骨格生成による in-memory Set 実装とテスト前提の差異が浮き彫りになり、曖昧性解消プロセスの一例として有益。