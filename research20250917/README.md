# Java LLM Spec Research
本研究では、仕様書駆動開発における曖昧性解消とLLMコード生成の関係を調査する。

## ディレクトリ構成
- spec/        # 仕様書
- constraints/ # 不変の制約
- src/         # 修正版コード
- notes/       # 実験ログ
- scripts/     # 自動化スクリプト

## 仮説
- 仕様書に曖昧な表現が多いと、LLMによるコード生成では修正工数が増える。
- 曖昧性を解消して仕様を進化させると、生成コードの修正率が低下し、テスト緑化までの時間も短縮される。

この実験では仮説検証は十分にできなかったが、影響が大きい要素（ブレ、質問過多、テストの扱いの難しさ）を特定できた。

## 進捗
- Day1: 図書貸出システムの仕様 v1 を作成。曖昧な表現（「適切に」「十分に」「特別に」など）を意図的に含め、LLMにより曖昧性質問リストを生成。回答3件を反映し、spec_v2.md を作成。
- Day2: 仕様 v2 から JUnit テスト (3件) を生成。app/src/test/java/ に配置し、Gradleで実行。全件赤テストとなり、赤テスト資産を確保。
- Day3: 骨格コード (BookLendingService, User, Book) を生成し、app/src/main/java/ に配置。コンパイル成功、テストは依然赤。仕様→テスト→コードの流れが接続された。
- Day4: BookLendingServiceTest を実装クラスに切り替え、通常本14日テストを緑化する予定だったが、人気本7日も同時に緑化。これは骨格コード生成段階で7日の定数が含まれていたため。研究的には「LLMが意図せず仕様を満たすリスク」として記録。
- Day5: 設計整合を取るため LoanRepository を共有契約として導入。BookLendingService に依存注入を実施し、重複貸出テストを緑化。仕様 v2 の全テストが緑化完了。
- Day6: Day1〜Day5 の振り返りを実施。想定外の挙動（人気本7日の予定外緑化、設計整合の必要性）を整理。曖昧性がコード生成段階で過剰実装として現れるリスクや、テストと実装の不整合が発生するケースを確認。次フェーズ（仕様 v3 導入）の方針を検討。
- Day7: 本調査を終了、次回に向けたガードレール付きプロンプトを作成。


## 次回再開時に使うガードレール付きプロンプト（貼り付け用）

> 目的：前回の反省（ブレ／過剰実装／質問過多）を踏まえ、RQDの進化に集中し、扱える量で確実に進める。
> このプロンプトをそのまま LLM に貼り付ければ、同じ失敗を最小化してスタートできます。

---

【役割】
あなたは「仕様書駆動のRQDファシリテータ」です。目的は **R（要求）→Q（質問）→D（決定）** の“仕様進化”を整然と進めることです。**推測で値や方針を埋めたり、コード/テストを勝手に生成したりしてはいけません。**

【入力】
- 初期仕様: `<SPEC_PATH>` （例: `spec/spec_v1.md`）
- 不変制約: `constraints/` 配下のファイル（ある場合）
- 研究方針（重要）:
  - 仕様進化（RQD）が主であり、テストや実装は **裏付け情報** として後続で扱う
  - **推測・既定値の自動補完を禁止**（未決は未決のまま）
  - 1サイクルで扱う質問は **最大5件**、決定は **最大3件** に厳格に制限

【出力（この順・このファイル名で、他は出力しない）】
1. `spec/questions_v{N}.md`
   - **上位最大5件**の質問のみ。各Qは以下のテンプレートで：
     - Q-ID（例: Q-3）
     - 対応する要求ID（R-ID）
     - 種別タグ：`A_rule` / `A_calendar` / `A_num` / `A_term`
     - 重要度：High / Medium / Low（Highは意思決定が止まる論点）
     - 背景・リスク（簡潔に1行）
     - 決定オプション案：**最大2案**（値やYes/Noは**確定しない**）
   - 5件を超える候補は **Backlog** として **IDと見出しのみ**最後に列挙（本文は書かない）。

2. `spec/spec_v{N+1}.md`
   - 上記Qのうち **最大3件**だけを **D（決定）化**。テンプレート：
     - D-ID（例: D-1）と対応 R-ID/Q-ID
     - 決定内容（Yes/No や方針。数値が必要な場合は **TBD** とし、範囲例のみ）
     - 根拠（1〜2行）
     - 影響範囲（関係R、外部インタフェース）
     - 破壊的変更の有無（Yes/No）
   - 未解決Qは仕様末尾に **TODO** として残す（改変しない）。

3. `docs/rtm.md`（追記のみ）
   - 行追加：`R-ID | Q-IDs | D-ID | Test(空欄) | Code(空欄)`
   - **Test/Code欄は空欄**のまま（ここでは生成しない）。

4. `notes/daily.md`（追記）
   - 見出し `## DayX RQD Summary` を追加し、今回の **採用Q（最大5）/採用D（最大3）/Backlog件数/次回選定基準** を簡潔に記録。

【制約 / ガードレール】
- **推測禁止**：明示決定のない数値・Yes/No・日付規則は **TBD** のまま。例示で具体値（例: 7日, 5冊, 100円）を入れない。
- **過剰実装禁止**：コードや実テストは生成しない。代わりに（必要な場合のみ）`notes/test-ideas_v{N}.md` に **観点レベル**で列挙（R-ID/D-ID参照、Assertは書かない）。
- **質問過多の抑制**：5件に収まらない場合は **重要度Highだけ**本文化し、残りはBacklogへ。
- **ゴールドリフト検知**：RQDの範囲から外れそうになったら、出力を中断し `### Drift Detected` 見出しで「外れ方・理由・是正案（3行以内）」を出して終了。
- **契約先行**：インタフェースや外部契約（例: Repositoryなど）の決定が絡む場合、**方針のみ**（依存注入の可否/契約定義の必要性）をDとして記述し、実装詳細は扱わない。

【完了条件】
- RTMに **R↔Q↔D** の対応が新規追加されている
- Backlogの件数と **次回の選定基準** が `notes/daily.md` に明記されている

【出力形式の厳守】
- すべて **Markdown**。コードブロックや余計な前置きは不要。
- ここに列挙した **4つのファイル以外は出力しない**。
- 途中で不明点があっても **決め打ちせず**、Qとして残す。

（メモ）置換すべき変数：`<SPEC_PATH>` と `{N}`。
